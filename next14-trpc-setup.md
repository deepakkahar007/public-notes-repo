# how to setup trpc, React Query with Next14 app dir

## install all packages

```bash
yarn add @trpc/client @trpc/server @trpc/react-query @tanstack/react-query superjson zod
```

## Setup with Next14 dir app

/src/server / trpc.ts;

```ts
import { initTRPC } from "@trpc/server";
import SuperJSON from "superjson";

const t = initTRPC.create({
  transformer: SuperJSON,
});

export const router = t.router;
export const procedure = t.procedure;
```

/src/server / index.ts;

```ts
import { router, procedure } from "./trpc";
import taskRouter from "./routes/task";

export const appRouter = router({
  home: procedure.query(() => {
    return "trpc home route";
  }),
  task: taskRouter,
});

export type AppRouter = typeof appRouter;
```

/src/app / api / trpc / [trpc] / route.ts;

```ts
import { fetchRequestHandler } from "@trpc/server/adapters/fetch";
import { appRouter } from "@/server";

const handler = (req: Request) =>
  fetchRequestHandler({
    endpoint: "/api/trpc",
    req,
    router: appRouter,
    createContext: () => ({}),
  });

export { handler as GET, handler as POST };
```

/src/app/\_trpc/client.ts

```ts
import { createTRPCReact } from "@trpc/react-query";
import { type AppRouter } from "@/server";

export const trpc = createTRPCReact<AppRouter>({});
```

/src/app/\_trpc/serverClient.ts

```ts
import { httpBatchLink } from "@trpc/client";
import { appRouter } from "@/server";

export const serverClient = appRouter.createCaller({
  links: [
    httpBatchLink({
      url: "http://localhost:3000/api/trpc",
    }),
  ],
});
```

/src/app/context/TrpcProvider.ts

```ts
"use client";
import { QueryClient, QueryClientProvider } from "@tanstack/react-query";
import { httpBatchLink } from "@trpc/client";
import React, { useState } from "react";
import SuperJSON from "superjson";

import { trpc } from "@/app/_trpc/client";

export default function TrpcProvider({
  children,
}: {
  children: React.ReactNode;
}) {
  const [queryClient] = useState(
    () =>
      new QueryClient({
        defaultOptions: {
          queries: {
            networkMode: "offlineFirst",
          },
        },
      })
  );
  const [trpcClient] = useState(() =>
    trpc.createClient({
      transformer: SuperJSON,
      links: [
        httpBatchLink({
          url: "http://localhost:3000/api/trpc",
        }),
      ],
    })
  );
  return (
    <trpc.Provider client={trpcClient} queryClient={queryClient}>
      <QueryClientProvider client={queryClient}>{children}</QueryClientProvider>
    </trpc.Provider>
  );
}
```

/src/app/layout.ts

```ts
import type { Metadata } from "next";
import "./globals.css";
import TrpcProvider from "@/app/context/Provider";

import { Navbar } from "./components";

export const metadata: Metadata = {
  title: "Create Next App",
  description: "Generated by create next app",
};

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang="en">
      <body>
        <TrpcProvider>{children}</TrpcProvider>
      </body>
    </html>
  );
}
```

## if any version error shows like this:

```bash
 тип ./node_modules/@trpc/react-query/dist/createHooksInternal-bdff7171.mjs
Attempted import error: 'hashQueryKey' is not exported from '@tanstack/react-query' (imported as 'hashQueryKey').

Import trace for requested module:
./node_modules/@trpc/react-query/dist/createHooksInternal-bdff7171.mjs
./node_modules/@trpc/react-query/dist/index.mjs
./src/app/_trpc/client.ts
./src/app/context/Provider.tsx
```

to solve it :

1. go to package.json
2. change @tanstack/react-query to ^4.35.3

```bash
"@tanstack/react-query": "^4.35.3",
"@trpc/client": "^10.45.0",
"@trpc/react-query": "^10.45.0",
"@trpc/server": "^10.45.0",
```
